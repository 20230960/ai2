<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>问卷</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans SC",sans-serif;
      margin:0;background:#f3f4f6;color:#111827;
    }
    .wrap{max-width:1100px;margin:12px auto;padding:8px 12px;}
    .card{background:#fff;border-radius:10px;padding:12px 14px;box-shadow:0 6px 16px rgba(15,23,42,.06);}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .badge{font-size:11px;padding:2px 7px;border-radius:999px;background:#eef2ff;color:#4338ca;}
    h1{font-size:18px;margin:0 0 6px 0;}
    .inst{font-size:13px;color:#6b7280;line-height:1.5;margin:0 0 10px 0;}
    .section{margin-top:14px;padding-top:10px;border-top:1px solid #f3f4f6;}
    .section h3{margin:0 0 8px 0;font-size:14px;}
    table{width:100%;border-collapse:collapse;table-layout:fixed;}
    th,td{border:1px solid #e5e7eb;padding:8px 6px;font-size:12px;vertical-align:middle;}
    th{background:#f9fafb;font-weight:600;color:#374151;}
    .item{width:48%;font-size:12.5px;line-height:1.4;}
    .c{text-align:center;}
    .anchors{display:flex;justify-content:space-between;font-size:12px;color:#6b7280;margin-top:6px;}
    .btnrow{margin-top:12px;display:flex;justify-content:flex-end;gap:10px;}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-size:13px;font-weight:600;background:#111827;color:#fff;cursor:pointer;}
    .btn2{border:1px solid #e5e7eb;background:#fff;color:#111827;}
    .btn:disabled{background:#9ca3af;cursor:not-allowed;opacity:.85;}
    .json{
      margin-top:10px;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:11px;white-space:pre-wrap;word-break:break-word;max-height:280px;overflow:auto;display:none;
    }

    /* ===== 背景信息（控制变量） ===== */
    .form-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){
      .form-grid{ grid-template-columns: 1fr; }
    }
    .field{
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:10px 10px;
      background:#fff;
    }
    .field label{
      display:block;
      font-size:12px;
      color:#374151;
      font-weight:600;
      margin-bottom:6px;
    }
    .field input[type="number"],
    .field select{
      width:100%;
      box-sizing:border-box;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:8px 10px;
      font-size:13px;
      outline:none;
    }
    .field .radio-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:#111827;
    }
    .field .hint{
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <span>问卷</span>
        <span class="badge">统一问卷页</span>
      </div>

      <h1>请完成以下问卷</h1>
      <p class="inst">
        请根据你刚才使用页面的体验作答。所有题目为 5 点量表（1=非常不同意，5=非常同意）。
      </p>

      <form id="surveyForm">
        <!-- ========== 背景信息（控制变量） ========== -->
        <div class="section" id="demoSection">
          <h3>背景信息（用于统计控制）</h3>

          <div class="form-grid">
            <!-- 性别 -->
            <div class="field">
              <label>性别</label>
              <div class="radio-row">
                <label><input type="radio" name="gender" value="male" required> 男</label>
                <label><input type="radio" name="gender" value="female" required> 女</label>
                <label><input type="radio" name="gender" value="other" required> 其他/不便说明</label>
              </div>
            </div>

            <!-- 年龄 -->
            <div class="field">
              <label for="age">年龄</label>
              <input id="age" name="age" type="number" min="16" max="99" step="1" required placeholder="例如：24">
              <div class="hint">请输入你的实际年龄（16–99）。</div>
            </div>

            <!-- 最高学历 -->
            <div class="field">
              <label for="edu">最高学历</label>
              <select id="edu" name="education" required>
                <option value="" disabled selected>请选择</option>
                <option value="highschool_or_below">高中及以下</option>
                <option value="associate">大专</option>
                <option value="bachelor">本科</option>
                <option value="master">硕士</option>
                <option value="phd">博士及以上</option>
                <option value="other">其他</option>
              </select>
            </div>

            <!-- 购物时间 -->
            <div class="field">
              <label for="shop_time">日常网购决策/浏览时长</label>
              <select id="shop_time" name="shopping_time" required>
                <option value="" disabled selected>请选择</option>
                <option value="lt5">5 分钟以内</option>
                <option value="5_10">5–10 分钟</option>
                <option value="11_20">11–20 分钟</option>
                <option value="21_30">21–30 分钟</option>
                <option value="gt30">30 分钟以上</option>
              </select>
              <div class="hint">指你在类似商品上通常用于查看信息、比较、做决定的时间。</div>
            </div>

            <!-- AI 使用频率 -->
            <div class="field">
              <label for="ai_freq">AI 使用经验（过去 3 个月使用频率）</label>
              <select id="ai_freq" name="ai_use_freq" required>
                <option value="" disabled selected>请选择</option>
                <option value="never">从不</option>
                <option value="rarely">很少（每月 1–2 次）</option>
                <option value="sometimes">偶尔（每周 1–2 次）</option>
                <option value="often">经常（每周 3–5 次）</option>
                <option value="very_often">非常频繁（几乎每天）</option>
              </select>
            </div>

            <!-- AI 熟练度 -->
            <div class="field">
              <label for="ai_skill">AI 使用熟练度（自评）</label>
              <select id="ai_skill" name="ai_skill" required>
                <option value="" disabled selected>请选择</option>
                <option value="1">1 = 非常不熟练</option>
                <option value="2">2</option>
                <option value="3">3 = 一般</option>
                <option value="4">4</option>
                <option value="5">5 = 非常熟练</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Likert 量表容器 -->
        <div id="surveyContainer"></div>

        <div class="btnrow">
          <button type="button" class="btn btn2" id="restartBtn">重新开始</button>
          <button type="submit" class="btn" id="submitBtn">提交</button>
        </div>

        <div id="jsonBox" class="json"></div>
      </form>

      <!-- ✅ 隐藏提交通道：iframe + form（用于确认写入成功） -->
      <iframe name="submitFrame" id="submitFrame" style="display:none;"></iframe>

      <form id="postForm" target="submitFrame" method="post"
            action="https://script.google.com/macros/s/AKfycbxtbadcIhotPE0R6EVae7Qsae1k5TZwizlqm2Tdi-4EXI5TmHkvvdPbs8y5U5JwgiX9/exec"
            style="display:none;">
        <input type="hidden" name="data" id="postData" value="">
      </form>
    </div>
  </div>

  <!-- exp_common.js 需要和本文件位于同一目录 -->
  <script src="exp_common.js"></script>
  <script>
    function fallbackCtx() {
      return {
        participant_id: sessionStorage.getItem("participant_id"),
        condition: sessionStorage.getItem("exp_condition") || (JSON.parse(sessionStorage.getItem("final_state") || "{}").condition || null),
        condition_url: sessionStorage.getItem("exp_condition_url"),
        task_start_ts: sessionStorage.getItem("task_start_ts"),
        task_end_ts: sessionStorage.getItem("task_end_ts"),
        interactionLog: JSON.parse(sessionStorage.getItem("interactionLog") || "[]"),
        final_state: JSON.parse(sessionStorage.getItem("final_state") || "{}"),
        page_extra: JSON.parse(sessionStorage.getItem("page_extra") || "{}"),
      };
    }

    const ctx = (window.Exp && typeof Exp.getContextForSurvey === "function")
      ? Exp.getContextForSurvey()
      : fallbackCtx();

    // 如果你入口页不是 start.html，请把这里改成 start1.html
    if (!ctx.participant_id || !ctx.condition) {
      window.location.replace("start.html");
    }

    const surveySpec = [
      {
        id: "pc",
        title: "感知控制",
        scaleMax: 5,
        left: "非常不同意",
        right: "非常同意",
        items: [
          "我可以自由选择在 AI 生成的评论摘要中查看哪些信息。",
          "我觉得自己能够控制摘要的生成与呈现方式（例如，调整摘要长度或关注的评价维度）。",
          "我能够将摘要输出引导到符合我需求的方向。"
        ]
      },
      {
        id: "int",
        title: "AI 评论摘要的可交互性",
        scaleMax: 5,
        left: "非常不同意",
        right: "非常同意",
        items: [
          "当我调整设置（如摘要长度或关注重点）后，AI 生成的评论摘要会迅速更新。",
          "AI 生成的评论摘要允许我以多种方式探索评论信息（例如按评价维度、按摘要长度）。",
          "该摘要支持“输入—反馈—再调整”的迭代互动过程（我调整设置后，摘要会随之动态变化）。",
          "与 AI 生成的评论摘要进行交互能让我持续关注商品信息。"
        ]
      },
      {
        id: "cx",
        title: "感知复杂度",
        scaleMax: 5,
        left: "非常不同意",
        right: "非常同意",
        items: [
          "调整 AI 评论摘要的设置会占用我较多时间，从而增加完成任务的负担。",
          "这个 AI 摘要的交互操作很复杂，我很难理解系统是如何根据我的设置生成/更新摘要的。",
          "为了得到我想要的摘要内容，我需要进行较多重复或机械性的操作（例如反复勾选维度、来回调整长度）。",
          "为了达到我想要的摘要效果，我觉得过程有些麻烦、需要投入额外精力。"
        ]
      },
      {
        id: "tp",
        title: "时间压力",
        scaleMax: 5,
        left: "非常不同意",
        right: "非常同意",
        items: [
          "为了按时完成本次商品评估任务，我必须加快速度。",
          "我感到有压力需要快速完成对商品信息的评估。",
          "我没有足够的时间去仔细阅读并评估 AI 生成的评论摘要。"
        ]
      }
    ];

    function renderSurvey() {
      const container = document.getElementById("surveyContainer");
      container.innerHTML = "";

      surveySpec.forEach((block) => {
        const sec = document.createElement("div");
        sec.className = "section";

        const h3 = document.createElement("h3");
        h3.textContent = block.title;
        sec.appendChild(h3);

        const table = document.createElement("table");

        // header
        const thead = document.createElement("thead");
        const hr = document.createElement("tr");
        const thItem = document.createElement("th");
        thItem.className = "item";
        thItem.textContent = "题项";
        hr.appendChild(thItem);

        for (let i = 1; i <= block.scaleMax; i++) {
          const th = document.createElement("th");
          th.className = "c";
          th.textContent = i;
          hr.appendChild(th);
        }
        thead.appendChild(hr);
        table.appendChild(thead);

        // body
        const tbody = document.createElement("tbody");
        block.items.forEach((text, idx) => {
          const tr = document.createElement("tr");
          const tdText = document.createElement("td");
          tdText.className = "item";
          tdText.textContent = text;
          tr.appendChild(tdText);

          const name = `${block.id}_${idx + 1}`;
          for (let v = 1; v <= block.scaleMax; v++) {
            const td = document.createElement("td");
            td.className = "c";
            const input = document.createElement("input");
            input.type = "radio";
            input.name = name;
            input.value = String(v);
            input.required = true;
            td.appendChild(input);
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        sec.appendChild(table);

        const anchors = document.createElement("div");
        anchors.className = "anchors";
        anchors.innerHTML = `<span>${block.left}</span><span>${block.right}</span>`;
        sec.appendChild(anchors);

        container.appendChild(sec);
      });
    }

    function getResponses() {
      const out = {};
      surveySpec.forEach((block) => {
        out[block.id] = {};
        block.items.forEach((_, idx) => {
          const name = `${block.id}_${idx + 1}`;
          const checked = document.querySelector(`input[name="${name}"]:checked`);
          out[block.id][name] = checked ? Number(checked.value) : null;
        });
      });
      return out;
    }

    function getDemographics() {
      const genderEl = document.querySelector('input[name="gender"]:checked');
      const ageEl = document.querySelector('input[name="age"]');
      const eduEl = document.querySelector('select[name="education"]');
      const shopEl = document.querySelector('select[name="shopping_time"]');
      const aiFreqEl = document.querySelector('select[name="ai_use_freq"]');
      const aiSkillEl = document.querySelector('select[name="ai_skill"]');

      return {
        gender: genderEl ? genderEl.value : null,
        age: ageEl && ageEl.value ? Number(ageEl.value) : null,
        education: eduEl ? eduEl.value : null,
        shopping_time: shopEl ? shopEl.value : null,
        ai_use_freq: aiFreqEl ? aiFreqEl.value : null,
        ai_skill: aiSkillEl && aiSkillEl.value ? Number(aiSkillEl.value) : null
      };
    }

    function genSubmissionId() {
      return "S" + Date.now().toString(36) + Math.random().toString(36).slice(2, 8).toUpperCase();
    }

    let pendingSubmissionId = null;

    function submitToAppsScriptWithAck(payload) {
      return new Promise((resolve, reject) => {
        pendingSubmissionId = payload.submission_id;

        const timer = setTimeout(() => {
          pendingSubmissionId = null;
          reject(new Error("timeout"));
        }, 30000);

        function onMessage(ev) {
          const allowed = new Set([
            "https://script.google.com",
            "https://script.googleusercontent.com"
          ]);
          if (!allowed.has(ev.origin)) return;

          const data = ev.data || {};
          if (typeof data.ok === "undefined") return;

          // 匹配本次提交
          if (pendingSubmissionId && data.submission_id && data.submission_id !== pendingSubmissionId) return;

          clearTimeout(timer);
          window.removeEventListener("message", onMessage);
          pendingSubmissionId = null;

          if (data.ok) resolve(data);
          else reject(new Error(data.error || "unknown_error"));
        }

        window.addEventListener("message", onMessage);

        // 通过隐藏 form POST 发送
        document.getElementById("postData").value = JSON.stringify(payload);
        document.getElementById("postForm").submit();
      });
    }

    renderSurvey();

    document.getElementById("restartBtn").addEventListener("click", () => {
      sessionStorage.clear();
      window.location.replace("start.html"); // 若入口是 start1.html，请改这里
    });

    document.getElementById("surveyForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!e.target.checkValidity()) {
        e.target.reportValidity();
        return;
      }

      const payload = {
        submission_id: genSubmissionId(),
        participant_id: ctx.participant_id,
        condition: ctx.condition,
        condition_url: ctx.condition_url,
        timestamps: {
          task_start_ts: ctx.task_start_ts,
          task_end_ts: ctx.task_end_ts,
          submit_ts: new Date().toISOString()
        },
        final_state: ctx.final_state,
        interactionLog: ctx.interactionLog,
        page_extra: ctx.page_extra,
        demographics: getDemographics(),
        survey: getResponses(),
        meta: { userAgent: navigator.userAgent, language: navigator.language }
      };

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;

      // 可选：显示 payload（调试用）
      const box = document.getElementById("jsonBox");
      box.style.display = "block";
      box.textContent = JSON.stringify(payload, null, 2);

      try {
        const ack = await submitToAppsScriptWithAck(payload);
        console.log("ACK =", ack);
        alert("提交成功，感谢参与！");
        // window.location.href = "thanks.html";
      } catch (err) {
        console.error(err);
        alert("提交失败或超时，请检查网络后重试。");
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
